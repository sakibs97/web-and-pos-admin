<!-- Page Header -->
<section class="page-header-section">
  <div class="page-header-card">
    <div class="header-content">
      <div class="header-title">
        <h1 class="page-title">
          <mat-icon class="title-icon">inventory</mat-icon>
          {{ adjustment ? 'Edit Stock Adjustment' : 'New Stock Adjustment' }}
        </h1>
        <p class="page-subtitle">{{ adjustment ? 'Update stock adjustment details' : 'Add stock in or stock out adjustment' }}</p>
      </div>
    </div>
  </div>
</section>

<!-- Adjustment Form -->
<section class="form-section">
  <div class="form-card">
    <div class="section-header">
      <mat-icon>edit</mat-icon>
      <h3>Adjustment Information</h3>
    </div>
    <div class="section-content">
      <form [formGroup]="dataForm" #formElement="ngForm" (ngSubmit)="onSubmit()">
        <div class="form-row">
          <div class="product-search-wrapper">
            <mat-form-field appearance="outline" class="product-search-field">
              <mat-label>Search Product *</mat-label>
              <input
                matInput
                type="text"
                [(ngModel)]="productSearchQuery"
                (input)="onProductSearch($any($event.target).value)"
                (keyup)="onProductSearch($any($event.target).value)"
                (focus)="onProductSearch(productSearchQuery)"
                placeholder="Search by product name or SKU"
                autocomplete="off">
              <mat-icon matPrefix>search</mat-icon>
              <mat-error *ngIf="!selectedProduct && dataForm.get('product')?.touched && dataForm.get('product')?.hasError('required')">Product is required</mat-error>
            </mat-form-field>
            <div class="product-search-results" *ngIf="searchResultsWithVariations.length > 0">
              <div
                *ngFor="let item of searchResultsWithVariations"
                (click)="onSelectSearchItem(item)"
                class="product-search-item">
                <div class="product-item-info">
                  <span class="product-item-name">{{item.displayName}}</span>
                  <span class="product-item-sku" *ngIf="item.sku">SKU: {{item.sku}}</span>
                  <span class="product-item-stock">Stock: {{item.stock}}</span>
                </div>
              </div>
            </div>
          </div>
          <div class="selected-product" *ngIf="selectedProduct">
            <div class="product-card">
              <mat-icon>inventory_2</mat-icon>
              <div class="product-details">
                <span class="product-name">
                  {{selectedVariation ? (selectedProduct.name + ' - ' + selectedVariation.name) : utilsService.getProductName(selectedProduct)}}
                </span>
                <span class="product-sku" *ngIf="selectedVariation?.sku || selectedProduct.sku">
                  SKU: {{selectedVariation?.sku || selectedProduct.sku}}
                </span>
                <span class="product-stock">
                  Current Stock: {{selectedVariation ? (selectedVariation.quantity || 0) : (selectedProduct.quantity || 0)}}
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Adjustment Type *</mat-label>
            <mat-select formControlName="adjustmentType">
              <mat-option value="stock_in">Stock In</mat-option>
              <mat-option value="stock_out">Stock Out</mat-option>
            </mat-select>
            <mat-error *ngIf="dataForm.get('adjustmentType')?.hasError('required')">Adjustment type is required</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Quantity *</mat-label>
            <input matInput formControlName="quantity" type="number" min="0.01" step="0.01" placeholder="0.00">
            <mat-error *ngIf="dataForm.get('quantity')?.hasError('required')">Quantity is required</mat-error>
            <mat-error *ngIf="dataForm.get('quantity')?.hasError('min')">Quantity must be greater than 0</mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Date *</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="date" placeholder="Choose date">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error *ngIf="dataForm.get('date')?.hasError('required')">Date is required</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Branch</mat-label>
            <mat-select formControlName="branch">
              <mat-option [value]="null">Main Store</mat-option>
              <mat-option *ngFor="let branch of branches" [value]="branch._id">
                {{ branch.websiteName }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Reason</mat-label>
            <textarea matInput formControlName="reason" rows="3" placeholder="Reason for adjustment (optional)"></textarea>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Reference</mat-label>
            <input matInput formControlName="reference" placeholder="Reference number or note (optional)">
          </mat-form-field>
        </div>

        <div class="action-buttons">
          <button type="button" mat-stroked-button routerLink="/pos/stock-adjustment/list">Cancel</button>
          <button type="submit" mat-raised-button color="primary" [disabled]="dataForm.invalid || isLoading">
            <mat-icon>save</mat-icon>
            {{ adjustment ? 'Update Adjustment' : 'Add Adjustment' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<app-page-loader *ngIf="isLoading"></app-page-loader>

