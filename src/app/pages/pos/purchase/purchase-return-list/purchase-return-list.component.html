<!-- Page Header -->
<section class="page-header-section">
  <div class="page-header-card">
    <div class="header-content">
      <div class="header-title">
        <h1 class="page-title">
          <mat-icon class="title-icon">undo</mat-icon>
          Purchase Return List
        </h1>
        <p class="page-subtitle">View and manage all purchase returns</p>
      </div>
      <div class="header-actions">
        <a routerLink="/pos/purchase/new-purchase-return" mat-raised-button color="primary" class="add-btn">
          <mat-icon>add</mat-icon>
          <span>New Return</span>
        </a>
      </div>
    </div>
  </div>
</section>

<!-- Filter & Search Section -->
<section class="filter-section">
  <div class="filter-card">
    <form #searchForm="ngForm" class="filter-content">
      <!-- Search -->
      <div class="search-container">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Search Returns</mat-label>
          <input matInput type="search" #searchInput name="searchTerm" autocomplete="off" ngModel
            placeholder="Search by return no, purchase no, supplier name/phone..." />
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>
      </div>

      <!-- Date Filter -->
      <div class="date-filter-container">
        <mat-form-field class="date-filter-field" appearance="outline" (click)="picker.open()">
          <mat-label>Date Range</mat-label>
          <mat-date-range-input [formGroup]="dataFormDateRange" [rangePicker]="picker" [max]="today">
            <input matStartDate formControlName="start" placeholder="Start date" readonly />
            <input matEndDate formControlName="end" placeholder="End date" readonly
              (dateChange)="endChangeRegDateRange($event)" />
          </mat-date-range-input>
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-date-range-picker #picker></mat-date-range-picker>
        </mat-form-field>
      </div>

      <!-- Month Filter -->
      <div class="filter-actions">
        <button mat-raised-button [matMenuTriggerFor]="menuMonth" class="filter-btn">
          <mat-icon>calendar_month</mat-icon>
          {{months[activeFilterMonth]?.viewValue || 'Month'}}
          <mat-icon>keyboard_arrow_down</mat-icon>
        </button>
        <mat-menu #menuMonth="matMenu">
          <button *ngFor="let data of months; let i = index" mat-menu-item (click)="filterData(data, i, 'month')"
            [class.active]="activeFilterMonth === i">
            {{ data?.viewValue }}
          </button>
        </mat-menu>

        <!-- Export Button -->
        <button mat-raised-button class="export-btn" (click)="exportToAllExcel()">
          <mat-icon>file_download</mat-icon>
          <span>Export Excel</span>
        </button>
      </div>
    </form>

    <!-- Clear Filter -->
    <div class="clear-filter" *ngIf="!isDefaultFilter && (filter || activeSort)">
      <button mat-stroked-button color="accent" (click)="onRemoveAllQuery()" class="clear-btn">
        <mat-icon>close</mat-icon>
        <span>Clear Filters</span>
      </button>
    </div>
  </div>
</section>

<!-- Summary Card -->
<section class="summary-section" *ngIf="calculation">
  <div class="summary-card">
    <div class="summary-icon">
      <mat-icon>undo</mat-icon>
    </div>
    <div class="summary-content">
      <h3 class="summary-label">Total Return Amount</h3>
      <p class="summary-value return-value">
        {{shopInformation?.currency | currencyIcon}}{{ calculation?.grandTotal ?? 0 | number: '1.2-2' }}
      </p>
    </div>
  </div>
</section>

<!-- Bulk Actions -->
<section class="bulk-actions-section" *ngIf="selectedIds && selectedIds.length">
  <div class="bulk-actions-card">
    <div class="selected-count">
      <mat-icon>check_circle</mat-icon>
      <span>{{selectedIds.length}} item(s) selected</span>
    </div>
    <div class="bulk-actions">
      <button *ngIf="checkDeletePermission" mat-raised-button color="warn" (click)="openConfirmDialog('delete')"
        class="delete-btn">
        <mat-icon>delete</mat-icon>
        <span>Delete Selected</span>
      </button>
    </div>
  </div>
</section>

<!-- Returns List -->
<section class="returns-list-section">
  <app-no-content *ngIf="!isLoading && !returns.length" [matIcon]="'undo'" title="No Purchase Returns Found!"
    description="Start by processing your first purchase return"></app-no-content>

  <div *ngFor="let group of returns; let i = index" class="returns-group">
    <!-- Group Header -->
    <div class="group-header">
      <div class="group-header-left">
        <mat-icon class="date-icon">event</mat-icon>
        <h2 class="group-date">{{ group?._id | date:'fullDate' }}</h2>
      </div>
      <div class="group-header-right">
        <span class="item-count">{{group.data.length}} return(s)</span>
      </div>
    </div>

    <!-- Returns Table -->
    <div class="table-card">
      <div class="table-responsive">
        <table class="modern-table">
          <thead>
            <tr>
              <th class="checkbox-col">
                <mat-checkbox #matCheckbox (change)="onAllSelectChange($event, group.data, i)"
                  color="primary"></mat-checkbox>
              </th>
              <th class="invoice-col">Return No</th>
              <th class="supplier-col">Supplier</th>
              <th class="phone-col">Phone</th>
              <th class="date-col">Date</th>
              <th class="amount-col">Return Total</th>
              <th class="action-col">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let returnPurchase of group.data; let j = index" class="table-row">
              <td class="checkbox-cell">
                <mat-checkbox [(ngModel)]="returnPurchase.select"
                  (ngModelChange)="onCheckChange($event, j, returnPurchase._id)" color="primary"></mat-checkbox>
              </td>
              <td class="invoice-cell">
                <div class="invoice-info">
                  <mat-icon class="invoice-icon">receipt</mat-icon>
                  <span class="invoice-number">{{ returnPurchase?.returnPurchaseNo }}</span>
                </div>
              </td>
              <td class="supplier-cell">
                <div class="supplier-info">
                  <mat-icon class="supplier-icon">business</mat-icon>
                  <span>{{ returnPurchase?.supplier?.name ?? '-' }}</span>
                </div>
              </td>
              <td class="phone-cell">
                <div class="phone-info">
                  <mat-icon class="phone-icon">phone</mat-icon>
                  <span>{{ returnPurchase?.supplier?.phone ?? '-' }}</span>
                </div>
              </td>
              <td class="date-cell">
                <div class="date-info">
                  <mat-icon class="date-icon-small">calendar_today</mat-icon>
                  <span>{{ returnPurchase?.returnDate ? (returnPurchase?.returnDate | date:'short') : '-' }}</span>
                </div>
              </td>
              <td class="amount-cell total-cell">
                <span class="total-value return-value">
                  {{shopInformation?.currency | currencyIcon}}{{ returnPurchase?.grandTotal | number:'1.2-2'}}
                </span>
              </td>
              <td class="action-cell">
                <div class="action-buttons">
                  <button mat-icon-button color="warn" matTooltip="Delete"
                    (click)="selectedIds = [returnPurchase._id]; openConfirmDialog('delete')">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </td>
            </tr>
            <!-- Group Total Row -->
            <tr class="group-total-row">
              <td></td>
              <td class="total-label-cell">
                <div class="total-label">
                  <mat-icon>summarize</mat-icon>
                  <span>Group Total ({{shopInformation?.currency | currencyIcon}})</span>
                </div>
              </td>
              <td></td>
              <td></td>
              <td></td>
              <td class="total-amount-cell grand-total-cell">
                <span class="grand-total-value return-value">{{ group.total | number:'1.2-2' }}</span>
              </td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<!-- Loading Spinner -->
<app-page-loader *ngIf="isLoading"></app-page-loader>